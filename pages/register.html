<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Argentum-Registro</title>
    <link rel="icon" type="image/x-icon" href="../static/images/logo.png" />
    <link rel="stylesheet" href="../static/css/loguin.css" />
    <script
      src="https://kit.fontawesome.com/2f8ba933a8.js"
      crossorigin="anonymous"
    ></script>

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>
  <body>
    <div class="form-container">
      <h1>Regístrate</h1>
      <div class="links">
        <a href="loguin.html">Inicio de Sesión</a>
        <a href="#" class="active">Registro</a>
      </div>
      <form
        action=""
        method="post"
        autocomplete="off"
        class="register"
        id="formulario"
      >
        <div class="form-item">
          <label for="nombre">
            <i class="fas fa-user"></i>
          </label>
          <input type="text" name="nombre" placeholder="Nombre" id="nombre" />
        </div>
        <div class="form-item">
          <label for="apellido">
            <i class="fas fa-user"></i>
          </label>
          <input
            type="text"
            name="apellido"
            placeholder="Apellido"
            id="apellido"
          />
        </div>
        <div class="form-item">
          <label for="dni">
            <i class="fas fa-user"></i>
          </label>
          <input type="number" name="dni" placeholder="Dni" id="dni" />
        </div>
        <div class="form-item">
          <label for="cuil">
            <i class="fas fa-user"></i>
          </label>
          <input type="number" name="cuil" placeholder="Cuil" id="cuil" />
        </div>
        <div class="form-item">
          <label for="username">
            <i class="fas fa-user"></i>
          </label>
          <input
            type="text"
            name="username"
            placeholder="Username"
            id="username"
          />
        </div>
        <div class="form-item">
          <label for="password">
            <i class="fas fa-lock"></i>
          </label>
          <input
            type="password"
            name="password"
            placeholder="Contraseña"
            id="password"
          />
        </div>
        <div class="form-item">
          <label for="email">
            <i class="fas fa-envelope"></i>
          </label>
          <input type="email" name="email" placeholder="Email" id="email" />
        </div>
        <div class="msg" id="msg"></div>
        <input type="submit" value="Registrarse" />
      </form>
    </div>
    <script>
      //const URL = "https://jenson.pythonanywhere.com/";
      const url = "https://maripilicruz.pythonanywhere.com/";
      
      document
        .getElementById("formulario")
        .addEventListener("submit", async function (event) {
          event.preventDefault();

          if (ValidarFormulario()) {
            let dni = document.getElementById("dni");
            try {
              let dniValidado = await ValidarDni(dni.value);
              if (dniValidado) {
                var formData = new FormData(this);
                fetch(URL + "clientes", {
                  method: "POST",
                  body: formData,
                })
                  .then(function (response) {
                    if (response.ok) {
                      return response.json();
                    } else {
                      throw new Error("Error al crear cuenta.");
                    }
                  })
                  .then(function (data) {
                    Swal.fire({
                      title: "¡Cuenta creada!",
                      text: "Cuenta creada correctamente.",
                      icon: "success",
                      confirmButtonText: "OK",
                    }).then(() => {
                      window.location = "loguin.html";
                    });
                  })
                  .catch(function (error) {
                    Swal.fire({
                      title: "Error",
                      text: "Error al crear la cuenta.",
                      icon: "error",
                      confirmButtonText: "OK",
                    });
                  });
              }
            } catch (error) {
              console.error("Error al validar DNI:", error);
            }
          }
        });

      async function ValidarDni(dni) {
        try {
          const response = await fetch(URL + "validarDni/" + dni, {
            method: "GET",
          });
          const data = await response.json();
          console.log(data);
          if (data.validado === false) {
            return true;
          } else {
            Swal.fire({
              title: "DNI Duplicado",
              text: "Ya existe una cuenta con este número de documento.",
              icon: "warning",
              confirmButtonText: "OK",
            });
            document.getElementById("dni").style.borderColor = "red";
            return false;
          }
        } catch (error) {
          console.error("Error en la solicitud:", error);
          return false;
        }
      }

      function ValidarFormulario() {
        let patron = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        if (
          document.getElementById("nombre").value.trim() == "" ||
          document.getElementById("apellido").value.trim() == "" ||
          document.getElementById("dni").value.trim() == "" ||
          document.getElementById("cuil").value.trim() == "" ||
          document.getElementById("username").value.trim() == "" ||
          document.getElementById("password").value.trim() == "" ||
          document.getElementById("email").value.trim() == ""
        ) {
          Swal.fire({
            title: "Campos Vacíos",
            text: "Debes completar todos los campos.",
            icon: "warning",
            confirmButtonText: "OK",
          });
          return false;
        }
        if (
          document.getElementById("dni").value.trim() < 0 ||
          document.getElementById("dni").value.trim() > 9999999999 ||
          document.getElementById("dni").value.trim().length < 8
        ) {
          Swal.fire({
            title: "Formato Incorrecto",
            text: "Formato de DNI no permitido.",
            icon: "warning",
            confirmButtonText: "OK",
          });
          return false;
        }
        if (
          document.getElementById("cuil").value.trim() < 0 ||
          document.getElementById("cuil").value.trim() > 9999999999999 ||
          document.getElementById("cuil").value.trim().length < 8
        ) {
          Swal.fire({
            title: "Formato Incorrecto",
            text: "Formato de Cuil no permitido.",
            icon: "warning",
            confirmButtonText: "OK",
          });
          return false;
        }
        if (!patron.test(document.getElementById("email").value.trim())) {
          Swal.fire({
            title: "Formato Incorrecto",
            text: "Formato de correo no permitido.",
            icon: "warning",
            confirmButtonText: "OK",
          });
          return false;
        }
        return true;
      }
    </script>
  </body>
</html>
